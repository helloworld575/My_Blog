{% extends 'article/base.html' %}
{% load staticfiles %}
{% load thumbnail %}
{% block title %}图片管理{% endblock %}

{% block content %}
<div>
    <button type="button" class="btn btn-primary btn-lg btn-block" onclick="addImage()">添加图片</button>
    <div style="margin-top: 10px;">
        <table class="table table-hover">
            <tr>
                <td>序号</td>
                <td>标题</td>
                <td>图片</td>
                <td>操作</td>
            </tr>
            {% for image in images %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ image.title }}</td>
                <td>
                {% thumbnail image.image "100" as im %}
                <img src="{{ im.url }}">
                {% endthumbnail %}
                </td>
                <td>
                    <a name="delete" href="javascript:" onclick="del_image(this,'{{ image.id }}','{{ image.title }}')"> <i
                                class="glyphicon glyphicon-trash"></i>
                    </a>
                </td>
            </tr>
            {% empty %}
            <p>还没有添加图片，点击上面按钮添加</p>
            {% endfor %}
        </table>
    </div>
{% include 'paginator.html' %}
</div>
{% endblock %}

{% block javascript %}
<script>
    function addImage(){
        var index = layer.open({
            type:1,
            skin:'layui-layer-rim',
            closeBtn:0,
            shift:2,
            shadeClose:true,
            title:"Add Image",
            area:['600px','400px'],
            content:'<div style="padding:20px"><p>请新增扩展名为.jpg或.png的网上照片的地址</p><form><div class="form-group"><label for="phototitle" class="col-sm-2 control-label">标题</label><div class="col-sm-10"><input id="phototitle" type="text" class="form-control" style="margin-bottom:5px;"></div></div><div class="form-group"><label for="photourl" class="col-sm-2 control-label">地址</label><div class="col-sm-10"><input id="photourl" type="text" class="form-control" style="margin-bottom:5px;"></div></div><div class="form-group"><label for="photodescription" class="col-sm-2 control-label">描述</label><div class="col-sm-10"><input id="photodescription" type="text" class="form-control" style="margin-bottom:5px;"></div></div><div class="form-group"><div class="col-sm-10 col-sm-offset-2"><input id="newphoto" type="button" value="增加" class="btn btn-default" style="margin-bottom:5px;"><div class="hidden" id="loadimg"><p>上传中，请稍候....</p><img src=\'{% static 'img/load.gif' %}\'/></div></div></div></form></div>',
            success:function () {
                $("#newphoto").on('click',function () {
                    var title=$("#phototitle").val();
                    var url=$("#photourl").val();
                    var description=$("#photodescription").val();
                    var photo = {"title":title,"url":url,"description":description};
                    $.ajax({
                        url:'{% url "image:upload_image" %}',
                        type:"POST",
                        data:photo,
                        beforeSend:function () {
                            $("#loadimg").removeClass("hidden");
                        },
                        success:function(e){
                            var status=e['status'];
                            if(status=="1"){
                                layer.msg("上传完成");
                                layer.close(index);
                                window.location.reload();
                            }else{
                                layer.msg("无法获取图片");
                                $("#loadimg").addClass("hidden");
                            }
                        },
                        error:function () {
                            layer.msg("无法连接到服务器")
                        }
                    })
                })
            }
        })
    }
    function del_image(the,id,title){
        layer.open({
            type:1,
            skin:'layui-layer-rim',
            title:"删除图片",
            area:['400px','200px'],
            content:'<div class="text-center" style="margin-top:20px;"><p>确定要删除图片：'+title+'?</p></div>',
            btn:['确定','取消'],
            yes:function () {
                $.ajax({
                    url:'{% url "image:del_image" %}',
                    type:"POST",
                    data:{"image_id":id},
                    success:function (e) {
                        if(e=="1"){
                            parent.location.reload();
                            layer.msg("删除完成");
                        }
                        else{
                            layer.msg("删除失败！");
                        }
                    }
                })
            }
        })
    }
</script>
{% endblock %}